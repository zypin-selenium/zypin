#!/usr/bin/env sh

# Get staged files
staged_files=$(git diff --cached --name-only)

# Check if any staged files are empty
if [ -z "$staged_files" ]; then
  exit 0
fi

# Lint and format staged files
echo "ğŸ¨ Running linter and formatter..."

# Get staged JS files (excluding templates and node_modules)
staged_js_files=$(echo "$staged_files" | grep '\.js$' | grep -v '^templates/' | grep -v 'node_modules')

if [ -n "$staged_js_files" ]; then
  # Format with Prettier
  echo "$staged_js_files" | xargs npx prettier --write

  # Lint with ESLint (auto-fix)
  echo "$staged_js_files" | xargs npx eslint --fix

  # Add fixed files back to staging
  echo "$staged_js_files" | xargs git add

  # Check if there are still linting errors
  if ! echo "$staged_js_files" | xargs npx eslint; then
    echo "âŒ ESLint found errors that cannot be auto-fixed. Please fix them manually."
    exit 1
  fi

  echo "âœ… Linting and formatting completed"
fi

echo "ğŸ” Checking for package changes..."

# Step 1: Bump packages with changes or detect manual bumps
bumped_packages=""
for package_dir in packages/*; do
  if [ -d "$package_dir" ] && [ -f "$package_dir/package.json" ]; then
    package_name=$(node -p "require('./$package_dir/package.json').name")

    # Case 1: Has code changes (excluding package.json)
    if echo "$staged_files" | grep "^$package_dir/" | grep -v "package.json$" | grep -q .; then
      (cd "$package_dir" && npm version patch --no-git-tag-version)
      echo "ğŸ“¦ Bumped $package_name"
      git add "$package_dir/package.json"
      bumped_packages="$bumped_packages $package_name"
    # Case 2: package.json is staged (manual bump or previous auto-bump)
    elif echo "$staged_files" | grep -q "^$package_dir/package.json$"; then
      echo "ğŸ“¦ Detected staged package: $package_name"
      bumped_packages="$bumped_packages $package_name"
    fi
  fi
done

if [ -n "$bumped_packages" ]; then
  git add package-lock.json
fi

# Step 2: Sync templates with bumped packages
if [ -n "$bumped_packages" ]; then
  echo "ğŸ”„ Syncing template dependencies..."

  for template_dir in templates/*; do
    if [ -d "$template_dir" ] && [ -f "$template_dir/package.json" ]; then
      template_updated=false

      # Check each bumped package
      for package_dir in packages/*; do
        if [ -d "$package_dir" ] && [ -f "$package_dir/package.json" ]; then
          package_name=$(node -p "require('./$package_dir/package.json').name")

          # Check if this package was bumped
          if echo "$bumped_packages" | grep -q "$package_name"; then
            package_version=$(node -p "require('./$package_dir/package.json').version")

            # Check if template depends on this package
            has_dep=$(node -p "require('./$template_dir/package.json').dependencies?.['$package_name'] || 'none'")

            if [ "$has_dep" != "none" ] && [ "$has_dep" != "undefined" ]; then
              echo "  ğŸ“ Updating $template_dir: $package_name -> ^$package_version"
              (cd "$template_dir" && npm pkg set dependencies.$package_name="^$package_version")
              template_updated=true
            fi
          fi
        fi
      done

      # Bump template if dependencies updated
      if [ "$template_updated" = true ]; then
        template_name=$(node -p "require('./$template_dir/package.json').name")
        echo "ğŸ“¦ Bumped $template_name"
        (cd "$template_dir" && npm version patch --no-git-tag-version)
        git add "$template_dir/package.json"
      fi
    fi
  done

  git add package-lock.json
fi

# Step 3: Bump templates with direct file changes
for template_dir in templates/*; do
  if [ -d "$template_dir" ] && [ -f "$template_dir/package.json" ]; then
    if echo "$staged_files" | grep "^$template_dir/" | grep -v "package.json$" | grep -q .; then
      template_name=$(node -p "require('./$template_dir/package.json').name")
      echo "ğŸ“¦ Bumped $template_name (file changes)"
      (cd "$template_dir" && npm version patch --no-git-tag-version)
      git add "$template_dir/package.json" package-lock.json
    fi
  fi
done

# Summary
if [ -z "$bumped_packages" ] && ! echo "$staged_files" | grep "^templates/" | grep -v "package.json$" | grep -q .; then
  echo "â„¹ï¸  No package changes detected"
else
  echo "âœ… Version bump completed"
fi
